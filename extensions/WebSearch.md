# 网络搜索

将网络搜索结果添加到LLM提示中。

## 可用来源

### Selenium插件

需要安装并启用官方服务器插件。

详情见 [SillyTavern-WebSearch-Selenium](https://github.com/SillyTavern/SillyTavern-WebSearch-Selenium)。

支持Google和DuckDuckGo引擎。

### Extras API

需要在主机上安装`websearch`模块和Chrome/Firefox网络浏览器。

支持Google和DuckDuckGo引擎。

### SerpApi

需要API密钥。

在此获取密钥：<https://serpapi.com/dashboard>

### SearXNG

需要SearXNG实例URL（可以是私有或公开的）。使用HTML格式返回搜索结果。

SearXNG偏好设置字符串：从SearXNG - 偏好设置 - COOKIES - 复制偏好哈希值中获取

了解更多：<https://docs.searxng.org/>

### Tavily AI

需要API密钥。

在此获取密钥：<https://app.tavily.com/>

### KoboldCpp

必须在文本完成API设置中提供KoboldCpp URL。KoboldCpp版本必须为>= 1.81.1，并且在启动时必须启用WebSearch模块：在GUI启动器中启用网络 => 启用WebSearch，或在命令行中添加`--websearch`。

详情见：<https://github.com/LostRuins/koboldcpp/releases/tag/v1.81.1>

### Serper

需要API密钥。

在此获取密钥：<https://serper.dev/>

## 如何使用

1. 确保使用最新版本的SillyTavern。
2. 通过SillyTavern中的“下载扩展和资产”菜单安装扩展。
3. 打开“网络搜索”扩展设置，设置您的API密钥或连接到Extras，并启用扩展。
4. 在您聊天时，网络搜索结果将有机地添加到提示中。**只有用户消息会触发搜索。**
5. 要更自然地包含搜索结果，请使用单反引号包裹搜索查询：```告诉我关于`最新的瑞恩·高斯林电影`。``` 将生成搜索查询`最新的瑞恩·高斯林电影`。
6. 可选地，根据您的喜好配置设置。

## 设置

### 常规

1. 启用 - 开关扩展。
2. 来源 = 设置搜索结果来源。
3. 缓存寿命 - 搜索结果在您的提示中缓存的时间（以秒为单位）。默认 = 一周。

### 提示设置

1. 提示预算 - 设置插入文本的最大容量（以文本字符计，不是令牌）。经验法则是：1个令牌约3-4个字符，根据您的模型上下文限制进行调整。默认 = 1500个字符。
2. 插入模板 - 结果如何插入提示。支持常用宏 + 特殊宏：\{\{query\}\} 表示搜索查询，\{\{text\}\} 表示搜索结果。
3. 注入位置 - 结果在提示中的位置。与作者注释相同选项：作为聊天注入或在系统提示之前/之后。

### 搜索激活

1. 使用功能工具 - 使用[功能调用](/For_Contributors/Function-Calling.md)激活搜索或抓取网页。必须使用支持的聊天完成API并在AI响应设置中启用。**启用时禁用所有其他激活方法。**
2. 使用反引号 - 启用使用单反引号包裹的词触发搜索。
3. 使用触发短语 - 启用使用触发短语激活搜索。
4. 正则表达式 - 提供JS风格的正则表达式以匹配用户消息。如果正则表达式匹配，将触发给定查询的搜索。搜索查询支持`{{macros}}`和$1语法来引用匹配的组。例如：`/what is happening in (.*)/i` 正则表达式用于搜索查询`news in $1`，将匹配包含`what is happening in New York`的消息，并触发查询`news in New York`的搜索。
5. 触发短语 - 逐一添加将触发搜索的短语。它可以出现在消息中的任何位置，查询从触发词开始，扩展到“最大词数”总数。要排除特定消息的处理，消息必须以句点开头，例如`.你觉得怎么样？`。触发优先级：首先按文本框中的顺序，然后是用户消息中的第一个。
6. 最大词数 - 搜索查询中包含的单词数（包括触发短语）。Google对每个提示的限制约为32个词。默认 = 10个词。

### 页面抓取

1. 访问链接 - 将从访问的搜索结果页面提取文本并保存到文件附件。
2. 访问次数 - 将访问并解析多少个链接的文本。
3. 访问域名黑名单 - 要排除访问的网站域名。每行一个。
4. 文件头 - 文件头模板，插入文本文件的开头，有额外的\{\{query\}\}宏。
5. 块头 - 链接块模板，随每个链接的解析内容插入。使用\{\{link\}\}宏表示页面URL，\{\{text\}\}表示页面内容。
6. 保存目标 - 保存抓取结果的位置。可选选项：触发消息附件，或数据银行的聊天附件，或仅图像（如果来源支持）。
7. 包括图像 - 将相关图像附加到聊天中。需要支持图像的来源（见下文）。

## 更多信息

来自最新查询的搜索结果将保留在提示中，直到找到下一个有效查询。
如果您想提出额外问题而不意外触发搜索，请在消息开头使用句点。

!!! info
如果启用并可用，网络搜索功能工具始终覆盖其他触发器。
!!!

触发优先级（如果启用了多个）：

1. 反引号。
2. 正则表达式。
3. 触发短语。

要丢弃所有之前的查询处理，请在用户消息开头使用感叹号，例如，用户消息`!现在让我们谈谈...`将丢弃此消息及其上面的所有消息。

此扩展还提供了一个`/websearch`斜杠命令，可在STscript中使用。更多信息见：[STscript语言参考](/For_Contributors/st-script.md#extension-commands)

```stscript
/websearch (links=on|off snippets=on|off [query]) – 执行网络搜索查询。使用命名参数指定返回内容 - 页面片段（默认：开启）、完整解析页面（默认：关闭）或两者兼有。

示例：/websearch links=off snippets=on 如何制作三明治
```

### 搜索结果中可以包含什么？

**词典：**

- 答案框：问题的直接答案。
- 知识图谱：关于主题的百科知识。
- 页面片段：网页的相关摘录。
- 相关问题：类似主题的问题和答案。
- 图像：相关图像。

#### SerpApi

1. 答案框。
2. 知识图谱。
3. 页面片段（最多10个）。
4. 相关问题（最多10个）。
5. 图像（最多10个）。

#### Selenium插件和Extras API

1. Google - 答案框，知识图谱，页面片段。
2. DuckDuckGo - 页面片段。

**Selenium插件**还可以额外提供图像。

#### SearXNG

1. 信息框。
2. 页面片段。
3. 图像。

#### Tavily AI

1. 答案。
2. 页面内容。
3. 图像（最多5个）。

#### KoboldCpp

1. 页面标题。
2. 页面片段。

#### Serper

1. 答案框。
2. 知识图谱。
3. 页面片段。
4. 相关问题。
5. 图像。
